
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>ChibiOS - Wind Farm Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chibios" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Wind Farm Documentation" class="md-header__button md-logo" aria-label="Wind Farm Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Wind Farm Documentation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              ChibiOS
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Wind Farm Documentation" class="md-nav__button md-logo" aria-label="Wind Farm Documentation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Wind Farm Documentation
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Wind Farm Project
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../esp-01/getting-started/" class="md-nav__link">
        Getting started with ESP01
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Dataproducer 01
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Dataproducer 01" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Dataproducer 01
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dataproducer-1/dataproducer-1/" class="md-nav__link">
        Dataproducer 1
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dataproducer-1/dht11/" class="md-nav__link">
        Humidity Sensor DH11
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dataproducer-1/graphical-lcd-backpack/" class="md-nav__link">
        Graphical LCD Backpack
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Dataproducer 02
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Dataproducer 02" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Dataproducer 02
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dataproducer-2/dataproducer-2/" class="md-nav__link">
        Data producer 2
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dataproducer-2/accelerometer/" class="md-nav__link">
        Accelerometer
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../dataproducer-2/liquidcrystali2c/" class="md-nav__link">
        Liquid Crystal Display connected with i2c bus
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          MQTT
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="MQTT" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          MQTT
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mqtt/broker/" class="md-nav__link">
        Example
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mqtt/mqtt/" class="md-nav__link">
        MQTT Broker
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../mqtt/mcp/" class="md-nav__link">
        MCP23027
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Supervision Station
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Supervision Station" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Supervision Station
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../Supervision-Station/" class="md-nav__link">
        Supervision
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          ChibiOS
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        ChibiOS
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-works" class="md-nav__link">
    How works?
  </a>
  
    <nav class="md-nav" aria-label="How works?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demos" class="md-nav__link">
    Demos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lcd-screen" class="md-nav__link">
    LCD Screen
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arduino-i2c" class="md-nav__link">
    Arduino I2C
  </a>
  
    <nav class="md-nav" aria-label="Arduino I2C">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#code-of-i2c" class="md-nav__link">
    Code of I2C
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code" class="md-nav__link">
    Code
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../arduino/" class="md-nav__link">
        Arduino
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../esp01/" class="md-nav__link">
        ESP-01 Subscriber
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    Introduction
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-works" class="md-nav__link">
    How works?
  </a>
  
    <nav class="md-nav" aria-label="How works?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    Requirements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#demos" class="md-nav__link">
    Demos
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lcd-screen" class="md-nav__link">
    LCD Screen
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#arduino-i2c" class="md-nav__link">
    Arduino I2C
  </a>
  
    <nav class="md-nav" aria-label="Arduino I2C">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#code-of-i2c" class="md-nav__link">
    Code of I2C
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code" class="md-nav__link">
    Code
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="chibios">ChibiOS</h1>
<h2 id="introduction">Introduction</h2>
<p><img alt="Photo" src="../img/chibios.png" /></p>
<ul>
<li>Abstracting away timing information. This allows the structure of the  application code to be simplier and smaller.</li>
<li>Maintainability/Extensibility. Fewer dependencies between modules.</li>
<li>Task modularity.</li>
<li>Event-driven means improved effiency.</li>
<li>Easier power management when idle task is detected.</li>
<li>Flexible interrupt handling</li>
</ul>
<h2 id="how-works">How works?</h2>
<h3 id="requirements">Requirements</h3>
<ol>
<li>Developer ARM Toolchain. <ul>
<li>Manual installation &gt; developer.arm.com</li>
<li>Package manager &gt; sudo apt-get install gcc-arm-none-eabi.</li>
</ul>
</li>
<li>Download specific version of ChibiOS for RPi B<ul>
<li><a href="github.com/steve-bate/Chibios-Rpi">Github repository of ChibiOS-RPi B</a></li>
</ul>
</li>
<li>Prepare Minimum bootable SD-Card for the Raspberry Pi B<ul>
<li>bootcode.ini - <a href="../data/bootcode.bin">Download here</a></li>
<li>start.elf - <a href="../data/start.elf">Download here</a></li>
<li>It has been said that <em>loader.bin</em> is not necessary, so we have deleted it.</li>
</ul>
</li>
</ol>
<p>In order to know if the Developer ARM Toolchain is correctly working:</p>
<pre><code>arm-none-eabi-gcc --version
</code></pre>
<p>Expected output:</p>
<pre><code>arm-none-eabi-gcc (15:9-2019-q4-0ubuntu2) 9.2.1 20191025 (release) [ARM/arm-9-branch revision 277599]
Copyright (C) 2019 Free Software Foundation, Inc.
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</code></pre>
<h3 id="demos">Demos</h3>
<p>The different demos can be downloaded from <a href="https://cv.udl.cat/access/content/group/103056-2122/Programs_Firmwares/ChibiOS/demos_ChibiOS.zip">here</a>. You will have to be in <code>ChibiOS-RPI/demos/&lt;name_demo&gt;</code>. The directory should have this structure</p>
<pre><code>- build/
    - ch.bin
    - ...
- chconf.h
- halconf.h
- main.c
- Makefile
- mcuconf.h
- readme.txt
</code></pre>
<p>In order to build the binary you must open the terminal and type <code>make</code>.</p>
<p>Then, in <code>build/</code> directory, it must have been created a <code>ch.bin</code> file. Put the file on the <strong>SD card</strong>  and rename it into <code>kernel.img</code>.</p>
<h2 id="lcd-screen">LCD Screen</h2>
<p>For LCD Screen, there is an example of that below. In the code, there has been added new functions to draw the graph of the data of the sensors, it is explained <a href="#code">here</a>.</p>
<pre><code class="language-c">
#include &quot;ch.h&quot;
#include &quot;hal.h&quot;
#include &quot;chprintf.h&quot;

static WORKING_AREA(waThread_LCD, 128);
static msg_t Thread_LCD(void *p) {
  (void)p;
  chRegSetThreadName(&quot;SerialPrint&quot;);
  uint16_t iteration=0;
  while (TRUE) {
    sdPut(&amp;SD1, (uint8_t)0x7C);
    sdPut(&amp;SD1, (uint8_t)0x18);
    sdPut(&amp;SD1, (uint8_t)0x20);
    chThdSleepMilliseconds(10);

    sdPut(&amp;SD1, (uint8_t)0x7C);
    sdPut(&amp;SD1, (uint8_t)0x19);
    sdPut(&amp;SD1, (uint8_t)0x10);
    chThdSleepMilliseconds(10);  

    chprintf((BaseSequentialStream *)&amp;SD1, &quot;Iter.: %u&quot;, iteration);
    iteration++;
    chThdSleepMilliseconds(2000);
  }
  return 0;
}


/*
 * Application entry point.
 */
int main(void) {
  halInit();
  chSysInit();


  // Initialize Serial Port
  sdStart(&amp;SD1, NULL); 

  // First Message
  chprintf((BaseSequentialStream *)&amp;SD1, &quot;Data consumer 1:&quot;); 

  // Coordinates
  sdPut(&amp;SD1, (uint8_t)0x7C);
  sdPut(&amp;SD1, (uint8_t)0x18);
  sdPut(&amp;SD1, (uint8_t)0x00);
  chThdSleepMilliseconds(10);

  sdPut(&amp;SD1, (uint8_t)0x7C);
  sdPut(&amp;SD1, (uint8_t)0x19);
  sdPut(&amp;SD1, (uint8_t)0x20);
  chThdSleepMilliseconds(10); 

  // Second message
  chprintf((BaseSequentialStream *)&amp;SD1, &quot;Data consumer 2&quot;);

  // Start thread
  chThdCreateStatic(waThread_LCD, sizeof(waThread_LCD), HIGHPRIO, Thread_LCD, NULL);

  /*
   * Events servicing loop.
   */
  chThdWait(chThdSelf());

  return 0;
}
</code></pre>
<p>The LCD Screen has some several issues about printing the floats, so it has been changed the <code>chprintf.h</code>, specifically, <code>ftoa</code> to not only change the precision of the float but also fix some bugs:</p>
<pre><code class="language-c">#define FLOAT_PRECISION 100

static char *ftoa(char *p, double num) {
  long l;
  unsigned long precision = FLOAT_PRECISION;

  l = (long) num;
  p = long_to_string_with_divisor(p, l, 10, 0);
  *p++ = '.';
  l = (long)((num - l) * precision);
  return long_to_string_with_divisor(p, l, 10, precision / 10);
}
</code></pre>
<p>Also, some macros have been created in order to set the different consants such as the total number of data saved in every dataproducer (20), or graphic LCD constants:</p>
<pre><code class="language-cpp">#define MAX_DATA_UNITS 20
#define START_DRAW_X 0x1D
#define MAX_X 0x79
#define MAX_Y_GRAPH 0x31
</code></pre>
<h2 id="arduino-i2c">Arduino I2C</h2>
<p>ChibiOS has a function to request the information on I2C bus, and in this document it shall be described how it works. The data is received through this function:</p>
<pre><code class="language-cpp">void i2cMasterTransmitTimeout(
    &amp;I2C0, // I2C bus
     // the address that you are requesting information
    arduino_address,
    NULL,// the request information
    0, // size sended in the request information
    (uint8_t *)&amp;data, // data received
    sizeof(sensor_data_t), // size of the data received
    MS2ST(1000) // I don't really know anything about this
    );
</code></pre>
<h3 id="code-of-i2c">Code of I2C</h3>
<pre><code class="language-c">
#include &quot;ch.h&quot;
#include &quot;hal.h&quot;
#include &quot;chprintf.h&quot;

static const uint8_t slave_address = 0x04;


static WORKING_AREA(waThread_I2C, 128);
static msg_t Thread_I2C(void *p) {
  (void)p;
  chRegSetThreadName(&quot;SerialPrintI2C&quot;);
  uint8_t request[]={0,0};
  uint8_t result=0;
  msg_t status;

  // Some time to allow slaves initialization
  chThdSleepMilliseconds(2000);

  while (TRUE) {

    // Request values
    i2cMasterTransmitTimeout(
                        &amp;I2C0, slave_address, request, 2, 
                        &amp;result, 1, MS2ST(1000));
    chThdSleepMilliseconds(10);

    sdPut(&amp;SD1, (int8_t)0x7C);
    sdPut(&amp;SD1, (int8_t)0x18);
    sdPut(&amp;SD1, (int8_t)0x00);
    chThdSleepMilliseconds(10);

    sdPut(&amp;SD1, (int8_t)0x7C);
    sdPut(&amp;SD1, (int8_t)0x19);
    sdPut(&amp;SD1, (int8_t)0x20);
    chThdSleepMilliseconds(10);

    chprintf((BaseSequentialStream *)&amp;SD1, &quot;Aval. %ux%u: %u  &quot;, 
                                     request[0],request[1], result);
    request[1]++;
    if (request[1]&gt;10) {
      request[1] = 0;
      request[0]++;
    }

    chThdSleepMilliseconds(2000);
  }
  return 0;
}

int main(void) {
  halInit();
  chSysInit();

  // Initialize Serial Port
  sdStart(&amp;SD1, NULL); 

  /*
   * I2C initialization.
   */
  I2CConfig i2cConfig;
  i2cStart(&amp;I2C0, &amp;i2cConfig);

  chThdCreateStatic(waThread_I2C, sizeof(waThread_I2C), 
                                          HIGHPRIO, Thread_I2C, NULL);

  // Blocks until finish
  chThdWait(chThdSelf());

  return 0;
}
</code></pre>
<h2 id="code">Code</h2>
<p>Regarding drawing and displaying the graph in the LCD Screen, to know how to draw the lines it has been searched the code of <em>LCD Sparkfun Backpack</em> and it has been created several functions such as <code>set_x</code>, <code>set_y</code>, <code>clear_screen</code>, <code>drawLine</code> to manage the LCD Screen.</p>
<pre><code class="language-c">
#include &quot;ch.h&quot;
#include &quot;hal.h&quot;
#include &quot;chprintf.h&quot;
#include &quot;chvt.h&quot;
#include &lt;string.h&gt;

#define N 10

#define TEMPERATURE_STATE 0
#define HUMIDITY_STATE 1
#define HEAT_INDEX 2
#define ACCEL_STATE_X 3
#define ACCEL_STATE_Y 4
#define ACCEL_STATE_Z 5

#define MAX_DATA_UNITS 20
#define START_DRAW_X 0x1D
#define MAX_X 0x79
#define MAX_Y_GRAPH 0x31

#define GET_VALUE(field, comparation)        \
  res = data_units[0].field;                 \
  for (int i = 1; i &lt; length; i++)           \
  {                                          \
    if (data_units[i].field comparation res) \
      res = data_units[i].field;             \
  }

static const uint8_t arduino_address = 0x04;

struct data_unit_t
{
  float humidity;
  float temperature;
  float heat_index;
  float accelerometerX;
  float accelerometerY;
  float accelerometerZ;
};

typedef struct
{
  float humidity;
  float temperature;
  float heatIndex;
} dataproducer1;

typedef struct
{
  float x;
  float y;
  float z;
} dataproducer2;

struct data_unit_t data_units[MAX_DATA_UNITS];
int length;
int num_dtp;
struct data_t *data;
dataproducer2 dt2;
msg_t msgDt2;

dataproducer1 dt1;
msg_t msgDt1;

float get_attribute(int state, int i);
void drawLine(uint8_t x1, uint8_t y1, uint8_t x2, uint8_t y2);
void add_struct_data_unit(int state);
void display_float(float f);
void display_int(int i);
void set_position(uint8_t x, uint8_t y);
void clear_screen(void);
void set_x(uint8_t x);
void set_y(uint8_t y);
char *get_title(int state);
void add_data(float humidity, float temperature, float heat_index, float accelX, float accelY, float accelZ);
void shift_data(void);
float get_min_value(int state);
float get_max_value(int state);
void printDataDt1(void);

static WORKING_AREA(waThread_LED1, 128);
static WORKING_AREA(waThread_LCD, 128);
static WORKING_AREA(waThread_I2C, 256);

static msg_t Thread_LCD(void *p)
{
  (void)p;
  chRegSetThreadName(&quot;SerialPrint&quot;);
  char *title;
  int state = TEMPERATURE_STATE;
  while (TRUE)
  {
    float min_val = get_min_value(state);
    float max_val = get_max_value(state);
    set_position(0x00, 0x3D);
    title = get_title(state);
    chprintf((BaseSequentialStream *)&amp;SD1, &quot;%s %d:&quot;, title, num_dtp);
    chThdSleepMilliseconds(10);
    drawLine(START_DRAW_X, 0x00, START_DRAW_X, 0x31);
    set_position(0x00, 0x31);
    display_float(max_val);
    set_position(0x00, 0x07);
    display_float(min_val);
    max_val++;
    min_val--;
    for (int i = length - 1; i &gt; 0; i--)
    {
      float last = get_attribute(state, i);
      float start = get_attribute(state, i - 1);
      int x_offset = MAX_DATA_UNITS - length + i;
      int x_last = START_DRAW_X + x_offset * 5;
      int x_start = START_DRAW_X + (x_offset - 1) * 5;
      int y_last = (last - min_val) / (max_val - min_val) * MAX_Y_GRAPH;
      int y_start = (start - min_val) / (max_val - min_val) * MAX_Y_GRAPH;
      drawLine(x_start, y_start, x_last, y_last);
    }
    state = (state + 1) % ACCEL_STATE_Z;

    chThdSleepMilliseconds(3000);
    clear_screen();
  }
  return 0;
}

float get_attribute(int state, int i)
{
  switch (state)
  {
  case TEMPERATURE_STATE:
    return data_units[i].temperature;
  case HUMIDITY_STATE:
    return data_units[i].humidity;
  case HEAT_INDEX:
    return data_units[i].heat_index;
  case ACCEL_STATE_X:
    return data_units[i].accelerometerX;
  case ACCEL_STATE_Y:
    return data_units[i].accelerometerY;
  default:
    return data_units[i].accelerometerZ;
  }
}

void display_int(int i)
{
  chprintf((BaseSequentialStream *)&amp;SD1, &quot;%d&quot;, (int)i);
  chThdSleepMilliseconds(500);
}

void display_float(float f)
{
  chprintf((BaseSequentialStream *)&amp;SD1, &quot;%f&quot;, (float)f);
  chThdSleepMilliseconds(500);
}

float get_min_value(int state)
{
  float res = -1;
  switch (state)
  {
  case TEMPERATURE_STATE:
    GET_VALUE(temperature, &lt;);
    break;
  case HUMIDITY_STATE:
    GET_VALUE(humidity, &lt;);
    break;
  case HEAT_INDEX:
    GET_VALUE(heat_index, &lt;);
    break;
  case ACCEL_STATE_X:
    GET_VALUE(accelerometerX, &lt;);
    break;
  case ACCEL_STATE_Y:
    GET_VALUE(accelerometerY, &lt;);
    break;
  default:
    GET_VALUE(accelerometerZ, &lt;);
    break;
  }
  return res;
}

float get_max_value(int state)
{
  float res = -1;
  switch (state)
  {
  case TEMPERATURE_STATE:
    GET_VALUE(temperature, &gt;);
    break;
  case HUMIDITY_STATE:
    GET_VALUE(humidity, &gt;);
    break;
  case HEAT_INDEX:
    GET_VALUE(heat_index, &gt;);
    break;
  case ACCEL_STATE_X:
    GET_VALUE(accelerometerX, &gt;);
    break;
  case ACCEL_STATE_Y:
    GET_VALUE(accelerometerY, &gt;);
    break;
  default:
    GET_VALUE(accelerometerZ, &gt;);
    break;
  }
  return res;
}

char *get_title(int state)
{
  switch (state)
  {
  case TEMPERATURE_STATE:
    return &quot;Temperature&quot;;
  case HUMIDITY_STATE:
    return &quot;Humidity&quot;;
  case HEAT_INDEX:
    return &quot;Heat index&quot;;
  case ACCEL_STATE_X:
    return &quot;Accelerometer x&quot;;
  case ACCEL_STATE_Y:
    return &quot;Accelerometer y&quot;;
  default:
    return &quot;Accelerometer z&quot;;
  }
}

void receiveSilentDt2(void)
{
  const uint8_t t = 0x01;
  msgDt2 = i2cMasterTransmitTimeout(&amp;I2C0, arduino_address, &amp;t, 1, (uint8_t *)&amp;dt2,
                                    sizeof(dataproducer2), MS2ST(1000));
  chThdSleepMilliseconds(3500);
}

void receiveSilentDt1(void)
{
  const uint8_t t = 0x00;
  msgDt1 = i2cMasterTransmitTimeout(&amp;I2C0, arduino_address, &amp;t, 1, (uint8_t *)&amp;dt1,
                                    sizeof(dataproducer1), MS2ST(1000));
  chThdSleepMilliseconds(3500);
}

static msg_t Thread_LED1(void *p)
{
  (void)p;
  chRegSetThreadName(&quot;blinker-1&quot;);
  while (TRUE)
  {
    printDataDt1();
    chThdSleepMilliseconds(3500);
    // chThdYield();
  }
  return 0;
}

void printDataDt1(void)
{
  add_data(dt1.humidity, dt1.temperature, dt1.heatIndex, dt2.x, dt2.y, dt2.z);
  switch (msgDt1)
  {
  case Q_TIMEOUT:
    break;
  case Q_OK:
    break;
  case Q_RESET:
    chprintf((BaseSequentialStream *)&amp;SD1, &quot;Reset: %d&quot;, msgDt1);
    i2cflags_t i2cFlags = i2cGetErrors(&amp;I2C0);
    chprintf((BaseSequentialStream *)&amp;SD1, &quot;Flags: %d&quot;, i2cFlags);
    I2CConfig i2cConfig;
    i2cStop(&amp;I2C0);
    i2cStart(&amp;I2C0, &amp;i2cConfig);
    break;
  default:
    break;
  }
}

static msg_t Thread_I2C(void *p)
{
  (void)p;
  chRegSetThreadName(&quot;Read all the information in I2C&quot;);
  dt1.humidity = 0.33f;
  dt1.temperature = 2.33f;
  dt1.heatIndex = 0.55f;
  while (TRUE)
  {
    receiveSilentDt1();
    receiveSilentDt2();
    // receiveSilently12Chars();
  }
  return 0;
}

/*
 * Application entry point.
 */
int main(void)
{
  halInit();
  chSysInit();

  length = 0;

  sdStart(&amp;SD1, NULL);

  I2CConfig i2cConfig;
  i2cStart(&amp;I2C0, &amp;i2cConfig);

  chThdCreateStatic(waThread_LED1, sizeof(waThread_LED1), HIGHPRIO, Thread_LED1,
                    NULL);

  chThdCreateStatic(waThread_LCD, sizeof(waThread_LCD), HIGHPRIO, Thread_LCD, NULL);

  chThdCreateStatic(waThread_I2C, sizeof(waThread_I2C), ABSPRIO, Thread_I2C,
                    NULL);

  chThdWait(chThdSelf());

  return 0;
}

void set_x(uint8_t x)
{
  sdPut(&amp;SD1, (uint8_t)0x7C);
  sdPut(&amp;SD1, (uint8_t)0x18);
  sdPut(&amp;SD1, (uint8_t)x);
  chThdSleepMilliseconds(10);
}

void set_y(uint8_t y)
{
  sdPut(&amp;SD1, (uint8_t)0x7C);
  sdPut(&amp;SD1, (uint8_t)0x19);
  sdPut(&amp;SD1, (uint8_t)y);
  chThdSleepMilliseconds(10);
}

void set_position(uint8_t x, uint8_t y)
{
  set_x(x);
  set_y(y);
}

void drawLine(uint8_t x1, uint8_t y1, uint8_t x2, uint8_t y2)
{
  //draws a line from two given points. You can set and reset just as the pixel function.
  sdPut(&amp;SD1, (uint8_t)0x7C);
  sdPut(&amp;SD1, (uint8_t)0x0C); //CTRL l
  sdPut(&amp;SD1, (uint8_t)x1);
  sdPut(&amp;SD1, (uint8_t)y1);
  sdPut(&amp;SD1, (uint8_t)x2);
  sdPut(&amp;SD1, (uint8_t)y2);
  sdPut(&amp;SD1, (uint8_t)0x01);
  chThdSleepMilliseconds(10);
}

void clear_screen(void)
{
  sdPut(&amp;SD1, (uint8_t)0x7C);
  sdPut(&amp;SD1, 0x00);
}

void add_data(float humidity, float temperature, float heat_index, float accelX, float accelY, float accelZ)
{
  if (length &lt; MAX_DATA_UNITS)
  {
    struct data_unit_t data_unit;
    memset(&amp;data_unit, 0, sizeof(struct data_unit_t));
    data_unit.humidity = humidity;
    data_unit.temperature = temperature;
    data_unit.heat_index = heat_index;
    data_unit.accelerometerX = accelX;
    data_unit.accelerometerY = accelY;
    data_unit.accelerometerZ = accelZ;
    data_units[length] = data_unit;
    length++;
  }
  else
  {
    shift_data();
    data_units[MAX_DATA_UNITS - 1].humidity = humidity;
    data_units[MAX_DATA_UNITS - 1].temperature = temperature;
    data_units[MAX_DATA_UNITS - 1].heat_index = heat_index;
    data_units[MAX_DATA_UNITS - 1].accelerometerX = accelX;
    data_units[MAX_DATA_UNITS - 1].accelerometerY = accelY;
    data_units[MAX_DATA_UNITS - 1].accelerometerZ = accelZ;
  }
}

void shift_data(void)
{
  for (int i = 1; i &lt; MAX_DATA_UNITS; i++)
  {
    data_units[i - 1] = data_units[i];
  }
}
</code></pre>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../Supervision-Station/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Supervision" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Supervision
            </div>
          </div>
        </a>
      
      
        
        <a href="../arduino/" class="md-footer__link md-footer__link--next" aria-label="Next: Arduino" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Arduino
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.b1047164.min.js"></script>
      
    
  </body>
</html>